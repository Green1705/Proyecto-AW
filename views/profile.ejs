<%- include('partials/head', { title: 'Mi perfil', extraStyles: ['/css/reservations.css'] }) %>
<%- include('partials/navbar') %>

<% const profileTextPref = (typeof textSizePreference === 'string' && textSizePreference.length) ? textSizePreference : 'normal'; %>
<% const profileContrastPref = (typeof contrastPreference === 'string' && contrastPreference.length) ? contrastPreference : 'normal'; %>
<main class="container py-5">
	<section class="reservations-table-section">
		<header class="mb-4">
			<h1 class="h3 mb-1">Historial de reservas</h1>
			<p class="text-muted mb-0">Consulta tus reservas finalizadas o canceladas.</p>
		</header>

		<div class="row gy-2 align-items-center mb-3">
			<div class="col-md-6">
				<div class="d-flex flex-column flex-sm-row gap-2">
					<span class="text-muted">Total de reservas:</span>
					<strong id="profile-total-count"><%= Array.isArray(reservations) ? reservations.length : 0 %></strong>
				</div>
			</div>
			<div class="col-md-6 d-flex flex-column flex-md-row justify-content-md-end gap-2">
				<button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#accessibilityModal">
					Accesibilidad
				</button>
				<a class="btn btn-outline-secondary" href="/logout">Cerrar sesión</a>
			</div>
		</div>

		<div class="row justify-content-end mb-3">
			<div class="col-md-6">
				<label for="profile-search" class="form-label visually-hidden">Buscar reservas</label>
				<input type="search" class="form-control" id="profile-search" placeholder="Buscar reservas..."
					data-search-row-selector=".reservation-row"
					data-detail-prefix="reservation-details-"
					data-detail-attr="data-reservation-id"
					data-count-target="#profile-total-count">
			</div>
		</div>

		<div class="table-responsive">
			<table class="table table-hover align-middle">
				<thead class="table-light">
					<tr>
						<th scope="col">Vehículo</th>
						<th scope="col">Cliente</th>
						<th scope="col">Periodo</th>
						<th scope="col" class="text-end">Estado</th>
					</tr>
				</thead>
				<tbody>
					<% if (Array.isArray(reservations) && reservations.length) { %>
						<% reservations.forEach((reservation) => { %>
							<tr class="reservation-row" tabindex="0" data-reservation-id="<%= reservation.id_reserva %>">
								<td>
									<strong>#<%= reservation.id_automovil %></strong>
									<span class="d-block text-muted small">Matrícula: <%= reservation.matricula || 'N/D' %></span>
								</td>
								<td>
									<strong><%= reservation.nombre_cliente %></strong>
									<span class="d-block text-muted small">DNI: <%= reservation.dni %></span>
								</td>
								<td>
									<span class="d-block"><strong>Inicio:</strong> <%= reservation.fecha_inicio %></span>
									<span class="d-block"><strong>Fin:</strong> <%= reservation.fecha_fin %></span>
								</td>
								<td class="text-end">
									<div class="d-flex justify-content-end gap-2">
										<span class="badge bg-light text-dark text-uppercase"><%= reservation.estado %></span>
										<button class="btn btn-outline-primary reservation-view-btn btn-sm" type="button">Ver</button>
									</div>
								</td>
							</tr>
							<tr class="reservation-details" id="reservation-details-<%= reservation.id_reserva %>">
								<td colspan="4">
									<div class="reservation-details-card">
										<ul class="reservation-specs list-unstyled mb-0">
											<li><strong>Número de reserva:</strong> <%= reservation.id_reserva %></li>
											<li><strong>Vehículo:</strong> #<%= reservation.id_automovil %> — Matrícula <%= reservation.matricula || 'N/D' %></li>
											<li><strong>Cliente:</strong> <%= reservation.nombre_cliente %> (DNI: <%= reservation.dni %>)</li>
											<li><strong>Empleado:</strong> <%= reservation.id_usuario || 'N/D' %></li>
											<li><strong>Fechas:</strong> <%= reservation.fecha_inicio %> hasta <%= reservation.fecha_fin %></li>
											<li><strong>Estado:</strong> <%= reservation.estado %></li>
											<li><strong>Precio final:</strong> €<%= reservation.precio_final %></li>
											<li><strong>Notas/Incidencias reportadas:</strong> <%= reservation.notas || 'Sin incidencias' %></li>
										</ul>
									</div>
								</td>
							</tr>
						<% }) %>
					<% } else { %>
						<tr>
							<td colspan="4" class="text-center text-muted py-5">
								No hay reservas registradas.
							</td>
						</tr>
					<% } %>
				</tbody>
			</table>
		</div>
	</section>
</main>

<div class="modal fade" id="accessibilityModal" tabindex="-1" aria-labelledby="accessibilityModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="accessibilityModalLabel">Opciones de accesibilidad</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
			</div>
			<form action="/perfil/accesibilidad" method="POST">
				<div class="modal-body">
					<p class="text-muted">Estos ajustes se aplicarán automáticamente en todas las páginas cuando guardes la configuración.</p>
					<div class="mb-4">
						<h6 class="mb-2">Contraste</h6>
						<div class="form-check">
							<input class="form-check-input" type="radio" name="contraste" id="contrast-normal" value="normal" <%= profileContrastPref === 'normal' ? 'checked' : '' %>>
							<label class="form-check-label" for="contrast-normal">Normal</label>
						</div>
						<div class="form-check">
							<input class="form-check-input" type="radio" name="contraste" id="contrast-high" value="alto" <%= profileContrastPref === 'alto' ? 'checked' : '' %>>
							<label class="form-check-label" for="contrast-high">Alto contraste</label>
						</div>
					</div>
					<div>
						<h6 class="mb-2">Tamaño del texto</h6>
						<div class="form-check">
							<input class="form-check-input" type="radio" name="tamanio_texto" id="text-small" value="pequeno" <%= profileTextPref === 'pequeno' ? 'checked' : '' %>>
							<label class="form-check-label" for="text-small">Reducido (−20%)</label>
						</div>
						<div class="form-check">
							<input class="form-check-input" type="radio" name="tamanio_texto" id="text-normal" value="normal" <%= profileTextPref === 'normal' ? 'checked' : '' %>>
							<label class="form-check-label" for="text-normal">Normal</label>
						</div>
						<div class="form-check">
							<input class="form-check-input" type="radio" name="tamanio_texto" id="text-large" value="grande" <%= profileTextPref === 'grande' ? 'checked' : '' %>>
							<label class="form-check-label" for="text-large">Ampliado (+20%)</label>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
					<button type="submit" class="btn btn-primary">Guardar preferencias</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script src="/js/reservations.js"></script>
<script src="/js/search.js"></script>

<%- include('partials/footer') %>
</body>
</html>

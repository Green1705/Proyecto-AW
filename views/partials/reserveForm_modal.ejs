<!-- Reserve Modal -->
<div class="modal fade" id="reserveModal" tabindex="-1" aria-labelledby="reserveModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
	<div class="modal-dialog modal-dialog-centered modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="reserveModalLabel">Registrar reserva</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
			</div>
			<div class="modal-body">
				<form action="/reserva/agregar" method="POST" class="row g-3" id="reserve-form">
					<input type="hidden" id="reserve-user-id" name="id_usuario" value="<%= typeof userId !== 'undefined' ? userId : '' %>" required>
					<input type="hidden" id="reserve-vehicle-id" name="id_automovil" value="<%= typeof selectedCarId !== 'undefined' ? selectedCarId : '' %>" required>
					<input type="hidden" id="reserve-daily-rate" value="<%= typeof selectedCarRate !== 'undefined' ? selectedCarRate : 0 %>">

					<div class="col-12 reserve-modal-summary alert alert-light border">
						Selecciona un vehículo para comenzar la reserva.
					</div>

					<div class="col-md-6">
						<label for="reserve-start" class="form-label">Fecha y hora de inicio</label>
						<input type="datetime-local" class="form-control" id="reserve-start" name="fecha_inicio" required>
					</div>

					<div class="col-md-6">
						<label for="reserve-end" class="form-label">Fecha y hora de fin</label>
						<input type="datetime-local" class="form-control" id="reserve-end" name="fecha_fin" required>
					</div>

					<input type="hidden" id="reserve-status" name="estado" value="activa">

					<div class="col-md-6">
						<label for="reserve-price" class="form-label">Precio final (€)</label>
						<input type="number" class="form-control" id="reserve-price" name="precio_final" min="0" step="0.01" readonly>
					</div>

					<div class="col-md-6">
						<label for="reserve-client-name" class="form-label">Nombre del cliente</label>
						<input type="text" class="form-control reserve-client-field" id="reserve-client-name" name="cliente_nombre" required>
					</div>

					<div class="col-md-6">
						<label for="reserve-client-lastname" class="form-label">Apellido paterno</label>
						<input type="text" class="form-control reserve-client-field" id="reserve-client-lastname" name="cliente_apellido_paterno" required>
					</div>

					<div class="col-md-6">
						<label for="reserve-client-second-lastname" class="form-label">Apellido materno</label>
						<input type="text" class="form-control reserve-client-field" id="reserve-client-second-lastname" name="cliente_apellido_materno">
					</div>

					<div class="col-md-6">
						<label for="reserve-client-dni" class="form-label">DNI / Pasaporte</label>
						<input type="text" class="form-control reserve-client-field" id="reserve-client-dni" name="cliente_dni" required>
					</div>

					<div class="col-md-6">
						<label for="reserve-client-phone" class="form-label">Teléfono</label>
						<input type="tel" class="form-control reserve-client-field" id="reserve-client-phone" name="cliente_telefono" required>
					</div>


					<div class="col-12">
						<label for="reserve-notes" class="form-label">Notas / incidencias</label>
						<textarea id="reserve-notes" name="incidencias_reportadas" class="form-control" rows="3" placeholder="Registrar incidencias o comentarios del cliente"></textarea>
					</div>

					<div class="col-12 d-flex align-items-end justify-content-end gap-3">
						<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
						<button type="submit" class="btn btn-primary">Guardar reserva</button>
					</div>
				</form>
			</div>
		</div>
	</div>
</div>

<script>
	(function setupReserveModal() {
		const modal = document.getElementById("reserveModal");
		if (!modal) return;
		const startInput = modal.querySelector("#reserve-start");
		const endInput = modal.querySelector("#reserve-end");
		const rateInput = modal.querySelector("#reserve-daily-rate");
		const priceInput = modal.querySelector("#reserve-price");
		const vehicleInput = modal.querySelector("#reserve-vehicle-id");
		const summary = modal.querySelector(".reserve-modal-summary");
		const clientFields = modal.querySelectorAll(".reserve-client-field");

		if (!startInput || !endInput || !rateInput || !priceInput || !vehicleInput) return;

		const updatePrice = () => {
			if (!startInput.value || !endInput.value) {
				priceInput.value = "";
				return;
			}
			const startDate = new Date(startInput.value);
			const endDate = new Date(endInput.value);
			const rate = parseFloat(rateInput.value || "0");
			if (isNaN(startDate) || isNaN(endDate) || endDate <= startDate || rate <= 0) {
				priceInput.value = "";
				return;
			}
			const diffMs = endDate.getTime() - startDate.getTime();
			const diffDays = Math.ceil(diffMs / (1000 * 60 * 60 * 24));
			const price = Math.round(diffDays * rate * 100) / 100;
			priceInput.value = price.toFixed(2);
		};

		["input", "change"].forEach((evt) => {
			startInput.addEventListener(evt, updatePrice);
			endInput.addEventListener(evt, updatePrice);
		});

		modal.addEventListener("show.bs.modal", (event) => {
			const button = event.relatedTarget;
			if (!button) return;
			const carId = button.getAttribute("data-car-id");
			const rate = button.getAttribute("data-car-rate");
			const carName = button.getAttribute("data-car-name") || "Vehículo seleccionado";
			const carPlate = button.getAttribute("data-car-matricula") || "Sin matrícula";

			vehicleInput.value = carId || "";
			rateInput.value = rate || "0";
			if (summary) summary.textContent = `Reserva para vehículo #${carId || "--"} — ${carName} (${carPlate})`;
			clientFields.forEach((field) => {
				field.value = "";
			});
			startInput.value = "";
			endInput.value = "";
			priceInput.value = "";
		});
	})();
</script>

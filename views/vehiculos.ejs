<%- include('partials/head', { title: 'Vehículos', extraStyles: ['/css/vehicles.css'] }) %>
<%- include('partials/navbar') %>

<% const rawVehicleDealerships = (typeof dealerships !== 'undefined') ? dealerships : []; %>
<% const vehicleDealerships = Array.isArray(rawVehicleDealerships) ? rawVehicleDealerships : []; %>
<main class="container py-5">
	<section class="vehicle-table-section">
		<header class="mb-4">
			<h1 class="h3 mb-1">Listado de vehículos</h1>
			<p class="text-muted mb-0">Selecciona un vehículo para ver sus detalles y reservarlo.</p>
		</header>
		<div class="row justify-content-end mb-3">
			<div class="col-md-6">
				<label for="vehicle-search" class="form-label visually-hidden">Buscar vehículos</label>
				<input type="search" class="form-control" id="vehicle-search" placeholder="Buscar vehículos..."
					data-search-row-selector=".vehicle-row" data-detail-prefix="vehicle-details-" data-detail-attr="data-car-id">
			</div>
		</div>

		<div class="table-responsive">
			<table class="table table-hover align-middle">
				<thead class="table-light">
					<tr>
						<th scope="col">Nombre</th>
						<th scope="col" class="text-end">ID</th>
					</tr>
				</thead>
				<tbody>
					<% if (Array.isArray(cars) && cars.length) { %>
						<% cars.forEach((car) => { %>
							<tr class="vehicle-row" data-car-id="<%= car.id_automovil %>">
								<td>
									<strong><%= car.marca %> <%= car.modelo %></strong>
									<span class="d-block text-muted small">Matrícula: <%= car.matricula %></span>
								</td>
								<td class="text-end fw-semibold">#<%= car.id_automovil %></td>
							</tr>
							<tr class="vehicle-details" id="vehicle-details-<%= car.id_automovil %>">
								<td colspan="2">
									<div class="vehicle-details-card">
										<div class="row g-4 align-items-center">
											<div class="col-md-4">
												<div class="vehicle-image">
													<% if (car.imagen) { %>
														<img src="<%= car.imagen %>" alt="<%= car.marca %> <%= car.modelo %>" class="img-fluid rounded">
													<% } else { %>
														<span>Imagen de <%= car.marca %> <%= car.modelo %></span>
													<% } %>
												</div>
											</div>
											<div class="col-md-5">
												<ul class="vehicle-specs">
													<li><strong>Matrícula:</strong> <%= car.matricula %></li>
													<li><strong>Año de matriculación:</strong> <%= car.anio_matriculacion %></li>
													<li><strong>Número de plazas:</strong> <%= car.numero_plazas %></li>
													<li><strong>Autonomía:</strong> <%= car.autonomia_km || 'N/D' %> km</li>
													<li><strong>Precio por día:</strong> €<%= Number(car.precio_por_dia).toFixed(2) %></li>
													<li><strong>Color:</strong> <%= car.color %></li>
													<li><strong>Estado:</strong> <%= car.estado %></li>
													<li><strong>Concesionario:</strong></li>
													<li><strong><%= car.concesionario_nombre %></strong></li>
												</ul>
											</div>
											<div class="col-md-3">
												<div class="vehicle-actions">
													<button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#reserveModal" data-car-id="<%= car.id_automovil %>" data-car-rate="<%= car.precio_por_dia %>" data-car-name="<%= `${car.marca} ${car.modelo}` %>" data-car-matricula="<%= car.matricula %>" <%= car.estado === 'disponible' ? '' : 'disabled' %>>
														Reservar
													</button>
												</div>
											</div>
										</div>
									</div>
								</td>
							</tr>
						<% }) %>
					<% } else { %>
						<tr>
							<td colspan="2" class="text-center text-muted py-5">
								No hay vehículos registrados actualmente.
							</td>
						</tr>
					<% } %>
				</tbody>
			</table>
		</div>
		</section>
	</main>

<script src="/js/vehicles.js"></script>
<script src="/js/search.js"></script>

<%- include('partials/reserveForm_modal', { dealerships: vehicleDealerships, userId }) %>

<%- include('partials/footer') %>

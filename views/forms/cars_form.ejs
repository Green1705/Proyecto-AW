<%- include('../partials/head', { title: 'Gestión de Vehículos', extraStyles: ['/css/admin_cars.css'] }) %>
<%- include('../partials/navbar') %>

<% const rawDealerships = typeof dealerships !== 'undefined' ? dealerships : []; %>
<% const availableDealerships = Array.isArray(rawDealerships) ? rawDealerships : []; %>
<main class="container py-5">
	<section class="vehicle-table-section">
		<header class="mb-4">
			<h1 class="h3 mb-1">Gestión de vehículos</h1>
			<div class="row g-3 align-items-center mb-3">
				<div class="col-md-6">
					<label for="admin-vehicle-search" class="form-label visually-hidden">Buscar vehículos</label>
					<input type="search" class="form-control" id="admin-vehicle-search" placeholder="Buscar vehículos..."
						data-search-row-selector=".vehicle-row" data-detail-prefix="vehicle-details-" data-detail-attr="data-car-id">
				</div>
				<div class="col-md-6 text-md-end">
					<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCarModal">
						Agregar vehículo
					</button>
				</div>
			</div>
			<% if (success && success.length) { %>
				<div class="alert alert-success py-2 mb-2"><%= success[0] %></div>
			<% } %>
			<% if (error && error.length) { %>
				<div class="alert alert-danger py-2 mb-2"><%= error[0] %></div>
			<% } %>
		</header>

		<div class="table-responsive">
			<table class="table table-hover align-middle">
				<thead class="table-light">
					<tr>
						<th scope="col">Nombre</th>
						<th scope="col" class="text-end">ID</th>
					</tr>
				</thead>
				<tbody>
					<% if (Array.isArray(cars) && cars.length) { %>
						<% cars.forEach((car) => { %>
							<tr class="vehicle-row" data-car-id="<%= car.id_automovil %>">
								<td>
									<strong><%= car.marca %> <%= car.modelo %></strong>
									<span class="d-block text-muted small">Matrícula: <%= car.matricula %></span>
								</td>
								<td class="text-end fw-semibold">#<%= car.id_automovil %></td>
							</tr>
							<tr class="vehicle-details" id="vehicle-details-<%= car.id_automovil %>">
								<td colspan="2">
									<div class="vehicle-details-card">
										<div class="row g-4 align-items-center">
											<div class="col-md-4">
												<div class="vehicle-image">
													<% if (car.imagen) { %>
														<img src="<%= car.imagen %>" alt="<%= car.marca %> <%= car.modelo %>" class="img-fluid rounded">
													<% } else { %>
														<span>Imagen de <%= car.marca %> <%= car.modelo %></span>
													<% } %>
												</div>
											</div>
											<div class="col-md-5">
												<ul class="vehicle-specs">
													<li><strong>Matrícula:</strong> <%= car.matricula %></li>
													<li><strong>Año de matriculación:</strong> <%= car.anio_matriculacion %></li>
													<li><strong>Número de plazas:</strong> <%= car.numero_plazas %></li>
													<li><strong>Autonomía:</strong> <%= car.autonomia_km || 'N/D' %> km</li>
													<li><strong>Precio por día:</strong> €<%= Number(car.precio_por_dia).toFixed(2) %></li>
													<li><strong>Color:</strong> <%= car.color %></li>
													<li><strong>Estado:</strong> <%= car.estado %></li>
													<li><strong>Concesionario:</strong></li>
													<li><strong><%= car.concesionario_nombre %></strong></li>
												</ul>
											</div>
											<div class="col-md-3">
												<div class="vehicle-actions">
													<button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#reserveModal" data-car-id="<%= car.id_automovil %>" data-car-rate="<%= car.precio_por_dia %>" data-car-name="<%= `${car.marca} ${car.modelo}` %>" data-car-matricula="<%= car.matricula %>" <%= car.estado === 'disponible' ? '' : 'disabled' %>>
														Reservar
													</button>
													<button type="button" class="btn btn-outline-primary w-100"
														data-edit-vehicle
														data-bs-toggle="modal" data-bs-target="#editCarModal"
														data-car-id="<%= car.id_automovil %>"
														data-car-matricula="<%= car.matricula %>"
														data-car-marca="<%= car.marca %>"
														data-car-modelo="<%= car.modelo %>"
														data-car-anio="<%= car.anio_matriculacion %>"
														data-car-plazas="<%= car.numero_plazas %>"
														data-car-autonomia="<%= car.autonomia_km %>"
														data-car-precio="<%= car.precio_por_dia %>"
														data-car-color="<%= car.color %>"
														data-car-estado="<%= car.estado %>"
														data-car-concesionario="<%= car.id_concesionario %>"
														data-car-imagen="<%= car.imagen %>">
														Modificar este vehículo
													</button>
													<form action="/admin/vehiculos/delete" method="POST" class="w-100">
														<input type="hidden" name="id_automovil" value="<%= car.id_automovil %>">
														<button type="submit" class="btn btn-outline-danger w-100" onclick="return confirm('¿Eliminar este vehículo?');">
															Eliminar este vehículo
														</button>
													</form>
												</div>
											</div>
										</div>
									</div>
								</td>
							</tr>
						<% }) %>
					<% } else { %>
						<tr>
							<td colspan="2" class="text-center text-muted py-5">
								No hay vehículos registrados actualmente.
							</td>
						</tr>
					<% } %>
				</tbody>
			</table>
		</div>
	</section>
</main>

<script src="/js/admin_cars.js"></script>
<script src="/js/search.js"></script>

<!-- Modal para nuevo vehículo -->
<div class="modal fade" id="addCarModal" tabindex="-1" aria-labelledby="addCarLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="addCarLabel">Nuevo vehículo</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
			</div>
			<form action="/admin/vehiculos" method="POST" enctype="multipart/form-data">
				<div class="modal-body">
					<div class="row g-3">
						<div class="col-md-6">
							<label for="car-matricula" class="form-label">Matrícula</label>
							<input type="text" class="form-control" id="car-matricula" name="matricula" required>
						</div>
						<div class="col-md-6">
							<label for="car-estado" class="form-label">Estado</label>
							<select class="form-select" id="car-estado" name="estado" required>
								<option value="disponible">Disponible</option>
								<option value="reservado">Reservado</option>
								<option value="mantenimiento">Mantenimiento</option>
							</select>
						</div>
						<div class="col-md-6">
							<label for="car-marca" class="form-label">Marca</label>
							<input type="text" class="form-control" id="car-marca" name="marca" required>
						</div>
						<div class="col-md-6">
							<label for="car-modelo" class="form-label">Modelo</label>
							<input type="text" class="form-control" id="car-modelo" name="modelo" required>
						</div>
						<div class="col-md-6">
							<label for="car-anio" class="form-label">Año de matriculación</label>
							<input type="number" class="form-control" id="car-anio" name="anio_matriculacion" required>
						</div>
						<div class="col-md-6">
							<label for="car-plazas" class="form-label">Número de plazas</label>
							<input type="number" class="form-control" id="car-plazas" name="numero_plazas" required>
						</div>
						<div class="col-md-6">
							<label for="car-autonomia" class="form-label">Autonomía (km)</label>
							<input type="number" class="form-control" id="car-autonomia" name="autonomia_km" required>
						</div>
						<div class="col-md-6">
							<label for="car-precio" class="form-label">Precio por día (€)</label>
							<input type="number" class="form-control" id="car-precio" name="precio_por_dia" step="0.01" min="0" required>
						</div>
						<div class="col-md-6">
							<label for="car-color" class="form-label">Color</label>
							<input type="text" class="form-control" id="car-color" name="color" required>
						</div>
						<div class="col-md-6">
							<label for="car-image" class="form-label">Imagen</label>
							<input type="file" class="form-control" id="car-image" name="imagen" accept="image/*" required>
						</div>
						<div class="col-12">
							<label for="car-dealership" class="form-label">ID concesionario</label>
							<input type="text" class="form-control" id="car-dealership" name="id_concesionario"
								list="car-dealership-options" inputmode="numeric" pattern="\\d+" placeholder="Selecciona un concesionario" required>
							<datalist id="car-dealership-options">
								<% availableDealerships.forEach((dealer) => { %>
									<option value="<%= dealer.id_concesionario %>"><%= dealer.nombre %></option>
								<% }) %>
							</datalist>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
					<button type="submit" class="btn btn-primary">Guardar</button>
				</div>
			</form>
		</div>
	</div>
</div>

<!-- Modal para editar vehículo -->
<div class="modal fade" id="editCarModal" tabindex="-1" aria-labelledby="editCarLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editCarLabel">Editar vehículo</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
			</div>
			<form action="/admin/vehiculos/update" method="POST" enctype="multipart/form-data">
				<input type="hidden" name="id_automovil" id="edit-car-id">
				<input type="hidden" name="current_imagen" id="edit-car-current-image">
				<div class="modal-body">
					<div class="row g-3">
						<div class="col-md-6">
							<label for="edit-car-matricula" class="form-label">Matrícula</label>
							<input type="text" class="form-control" id="edit-car-matricula" name="matricula" required>
						</div>
						<div class="col-md-6">
							<label for="edit-car-estado" class="form-label">Estado</label>
							<select class="form-select" id="edit-car-estado" name="estado" required>
								<option value="disponible">Disponible</option>
								<option value="reservado">Reservado</option>
								<option value="mantenimiento">Mantenimiento</option>
							</select>
						</div>
						<div class="col-md-6">
							<label for="edit-car-marca" class="form-label">Marca</label>
							<input type="text" class="form-control" id="edit-car-marca" name="marca" required>
						</div>
						<div class="col-md-6">
							<label for="edit-car-modelo" class="form-label">Modelo</label>
							<input type="text" class="form-control" id="edit-car-modelo" name="modelo" required>
						</div>
						<div class="col-md-6">
							<label for="edit-car-anio" class="form-label">Año de matriculación</label>
							<input type="number" class="form-control" id="edit-car-anio" name="anio_matriculacion" required>
						</div>
						<div class="col-md-6">
							<label for="edit-car-plazas" class="form-label">Número de plazas</label>
							<input type="number" class="form-control" id="edit-car-plazas" name="numero_plazas" required>
						</div>
						<div class="col-md-6">
							<label for="edit-car-autonomia" class="form-label">Autonomía (km)</label>
							<input type="number" class="form-control" id="edit-car-autonomia" name="autonomia_km" required>
						</div>
						<div class="col-md-6">
							<label for="edit-car-precio" class="form-label">Precio por día (€)</label>
							<input type="number" class="form-control" id="edit-car-precio" name="precio_por_dia" step="0.01" min="0" required>
						</div>
						<div class="col-md-6">
							<label for="edit-car-color" class="form-label">Color</label>
							<input type="text" class="form-control" id="edit-car-color" name="color" required>
						</div>
						<div class="col-md-6">
							<label for="edit-car-image" class="form-label">Imagen (opcional)</label>
							<input type="file" class="form-control" id="edit-car-image" name="imagen" accept="image/*">
						</div>
						<div class="col-12">
							<label for="edit-car-dealership" class="form-label">ID concesionario</label>
							<input type="text" class="form-control" id="edit-car-dealership" name="id_concesionario"
								list="car-dealership-options" inputmode="numeric">
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
					<button type="submit" class="btn btn-primary">Guardar cambios</button>
				</div>
			</form>
		</div>
	</div>
</div>

<%- include('../partials/reserveForm_modal') %>

<%- include('../partials/footer') %>

<%- include('../partials/head', { title: 'Gestión de Empleados', extraStyles: ['/css/admin_employees.css'] }) %>
<%- include('../partials/navbar') %>

<% const availableDealerships = Array.isArray(dealerships) ? dealerships : []; %>
<main class="container py-5">
	<section class="employee-section">
		<header class="mb-4">
			<h1 class="h3 mb-1">Gestión de empleados</h1>
			<div class="row g-3 align-items-center mb-3">
				<div class="col-md-6">
					<label for="employee-search" class="form-label visually-hidden">Buscar empleados</label>
					<input type="search" class="form-control" id="employee-search" placeholder="Buscar empleados..."
						data-search-row-selector=".employee-row" data-detail-prefix="employee-details-" data-detail-attr="data-employee-id">
				</div>
				<div class="col-md-6 text-md-end">
					<button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addEmployeeModal">
						Agregar empleado
					</button>
				</div>
			</div>
			<% if (success && success.length) { %>
				<div class="alert alert-success py-2 mb-2"><%= success[0] %></div>
			<% } %>
			<% if (error && error.length) { %>
				<div class="alert alert-danger py-2 mb-2"><%= error[0] %></div>
			<% } %>
		</header>

		<div class="table-responsive">
			<table class="table table-hover align-middle">
				<thead class="table-light">
					<tr>
						<th scope="col">Nombre</th>
						<th scope="col" class="text-end">ID</th>
					</tr>
				</thead>
				<tbody>
					<% if (Array.isArray(employees) && employees.length) { %>
						<% employees.forEach((employee) => { %>
							<tr class="employee-row" tabindex="0" data-employee-id="<%= employee.id_usuario %>">
								<td>
									<strong><%= employee.nombre %> <%= employee.apellido_paterno %></strong>
									<span class="d-block text-muted small">Rol: <%= employee.rol %></span>
								</td>
								<td class="text-end fw-semibold">#<%= employee.id_usuario %></td>
							</tr>
							<tr class="employee-details" id="employee-details-<%= employee.id_usuario %>">
								<td colspan="2">
									<div class="employee-details-card">
										<div class="row g-4">
											<div class="col-md-8">
												<ul class="employee-info">
													<li><strong>Nombre completo:</strong> <%= employee.nombre %> <%= employee.apellido_paterno %> <%= employee.apellido_materno || '' %></li>
													<li><strong>Rol:</strong> <%= employee.rol %></li>
													<li><strong>Email:</strong> <%= employee.email %></li>
													<li><strong>Teléfono:</strong> <%= employee.telefono %></li>
													<li><strong>ID Concesionario:</strong> <%= employee.id_concesionario || 'N/D' %></li>
												</ul>
											</div>
										</div>
									</div>
								</td>
							</tr>
						<% }) %>
					<% } else { %>
						<tr>
							<td colspan="2" class="text-center text-muted py-5">
								No hay empleados registrados actualmente.
							</td>
						</tr>
					<% } %>
				</tbody>
			</table>
		</div>
	</section>
</main>

<script src="/js/admin_employees.js"></script>
<script src="/js/search.js"></script>

<!-- Modal agregar empleado -->
<div class="modal fade" id="addEmployeeModal" tabindex="-1" aria-labelledby="addEmployeeLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="addEmployeeLabel">Nuevo empleado</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
			</div>
			<form action="/admin/empleados" method="POST">
				<div class="modal-body">
					<div class="row g-3">
						<div class="col-md-6">
							<label for="employee-name" class="form-label">Nombre</label>
							<input type="text" class="form-control" id="employee-name" name="nombre" required>
						</div>
						<div class="col-md-6">
							<label for="employee-lastname" class="form-label">Apellido paterno</label>
							<input type="text" class="form-control" id="employee-lastname" name="apellido_paterno" required>
						</div>
						<div class="col-md-6">
							<label for="employee-second-lastname" class="form-label">Apellido materno</label>
							<input type="text" class="form-control" id="employee-second-lastname" name="apellido_materno">
						</div>
						<div class="col-md-6">
							<label for="employee-role" class="form-label">Rol</label>
							<select class="form-select" id="employee-role" name="rol" required>
								<option value="empleado">Empleado</option>
								<option value="administrador">Administrador</option>
							</select>
						</div>
						<div class="col-md-6">
							<label for="employee-email" class="form-label">Correo</label>
							<input type="email" class="form-control" id="employee-email" name="email"
								pattern="^[a-zA-Z0-9._%+-]+@aem\.com$"
								title="El correo debe terminar en @aem.com" required>
						</div>
						<div class="col-md-6">
							<label for="employee-password" class="form-label">Contraseña</label>
							<input type="password" class="form-control" id="employee-password" name="password"
								minlength="8"
								pattern="^(?=.*[A-Z])(?=.*\d).{8,}$"
								title="Mínimo 8 caracteres, con al menos una mayúscula y un número" required>
						</div>
						<div class="col-md-6">
							<label for="employee-phone" class="form-label">Teléfono</label>
							<input type="tel" class="form-control" id="employee-phone" name="telefono" required>
						</div>
						<div class="col-md-6">
							<label for="employee-dealership" class="form-label">ID concesionario</label>
							<input type="text" class="form-control" id="employee-dealership" name="id_concesionario"
								list="employee-dealership-options" inputmode="numeric" placeholder="Selecciona un concesionario">
							<datalist id="employee-dealership-options">
								<% availableDealerships.forEach((dealer) => { %>
									<option value="<%= dealer.id_concesionario %>"><%= dealer.nombre %></option>
								<% }) %>
							</datalist>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
					<button type="submit" class="btn btn-primary">Guardar empleado</button>
				</div>
			</form>
		</div>
	</div>
</div>
<script src="/js/search.js"></script>

<%- include('../partials/footer') %>
